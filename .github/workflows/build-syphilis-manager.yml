name: Build Syphilis Manager

on:
  workflow_dispatch:
    inputs:
      inputs_release_tag:
        description: 'Release tag for build inputs (e.g. syphilis-manager-inputs-v1.0.0)'
        required: true
        default: 'syphilis-manager-inputs-v1.0.0'
        type: string
      surveillance_release_tag:
        description: 'Release tag for surveillance manager (e.g. surveillance-manager-v1.0.0-alpha)'
        required: true
        default: 'surveillance-manager-v1.0.0-alpha'
        type: string
      jheem2_ref:
        description: 'jheem2 branch or tag to use'
        required: false
        default: 'dev'
        type: string
      update_spec:
        description: 'Regenerate the structural spec from this build (use when structure changes intentionally)'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout jheem_analyses
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout jheem2
        uses: actions/checkout@v4
        with:
          repository: tfojo1/jheem2
          ref: ${{ inputs.jheem2_ref }}
          path: _jheem2

      - name: Symlink jheem2 as sibling directory
        run: ln -s "$GITHUB_WORKSPACE/_jheem2" "$GITHUB_WORKSPACE/../jheem2"

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: r-packages-${{ hashFiles('**/DESCRIPTION') }}
          restore-keys: r-packages-

      - name: Install R dependencies
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          install.packages(c("remotes", "jsonlite", "readxl", "dplyr", "stringr", "tidyr"))
          remotes::install_github("tfojo1/locations")
          remotes::install_local("_jheem2", upgrade = "never")
        shell: Rscript {0}

      - name: Download build inputs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p _ci_inputs/sections _ci_inputs/birth_data
          gh release download "${{ inputs.inputs_release_tag }}" \
            --dir _ci_inputs/sections \
            --pattern "syphilis.manager_section*.rdata"
          gh release download "${{ inputs.inputs_release_tag }}" \
            --dir _ci_inputs/birth_data \
            --pattern "*.xlsx"
          gh release download "${{ inputs.inputs_release_tag }}" \
            --dir _ci_inputs \
            --pattern "stratification_analysis_results_county_based.rdata"

      - name: Download surveillance manager
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ inputs.surveillance_release_tag }}" \
            --dir _ci_inputs \
            --pattern "surveillance.manager.rdata"

      - name: Run merge pipeline
        env:
          SECTION_DIR: _ci_inputs/sections
          OUTPUT_DIR: _ci_outputs
          ARCHIVE_DIR: _ci_outputs
          CACHED_DIR: _ci_outputs
          BIRTH_DATA_DIR: _ci_inputs/birth_data
          SURVEILLANCE_MANAGER_PATH: _ci_inputs/surveillance.manager.rdata
          STRAT_RESULTS_PATH: _ci_inputs/stratification_analysis_results_county_based.rdata
        run: |
          mkdir -p _ci_outputs
          Rscript -e "
            library(jheem2)
            library(locations)
            library(dplyr)
            library(readxl)
            library(stringr)
            library(tidyr)
            source('data_processing/syphilis.manager/syphilis.processing.for.merging/syphilis.manager.merge.R')
          " 2>&1 | tee _ci_outputs/build_log.txt

      - name: Update spec from build
        if: inputs.update_spec
        run: |
          Rscript data_processing/syphilis.manager/validation/generate_spec.R \
            _ci_outputs/syphilis.manager.rdata

      - name: Run validation
        if: ${{ !inputs.update_spec }}
        run: |
          set -o pipefail
          Rscript data_processing/syphilis.manager/validation/run_validation.R \
            _ci_outputs/syphilis.manager.rdata \
            2>&1 | tee _ci_outputs/validation_report.txt

      - name: Commit updated spec
        if: inputs.update_spec
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data_processing/syphilis.manager/validation/syphilis_manager_spec.json
          git diff --cached --quiet && echo "No spec changes" || \
            git commit -m "Update syphilis manager spec from CI build

          Inputs: ${{ inputs.inputs_release_tag }}
          Surveillance: ${{ inputs.surveillance_release_tag }}
          jheem2: ${{ inputs.jheem2_ref }}"
          git push

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: syphilis-manager-build
          path: |
            _ci_outputs/build_log.txt
            _ci_outputs/validation_report.txt

      - name: Create release
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION_TAG="syphilis-manager-v$(date +%Y%m%d)-$(echo $GITHUB_SHA | cut -c1-7)"
          SPEC_NOTE=""
          if [ "${{ inputs.update_spec }}" = "true" ]; then
            SPEC_NOTE="Spec: UPDATED (review commit)"
          else
            SPEC_NOTE="Validation: PASSED"
          fi
          NOTES="Built from inputs: \`${{ inputs.inputs_release_tag }}\`
          Surveillance manager: \`${{ inputs.surveillance_release_tag }}\`
          jheem2 ref: \`${{ inputs.jheem2_ref }}\`
          Commit: \`$GITHUB_SHA\`

          $SPEC_NOTE"
          ASSETS="_ci_outputs/syphilis.manager.rdata"
          if [ -f _ci_outputs/validation_report.txt ]; then
            ASSETS="$ASSETS _ci_outputs/validation_report.txt"
          fi
          gh release create "$VERSION_TAG" \
            --title "Syphilis Manager $VERSION_TAG" \
            --notes "$NOTES" \
            $ASSETS
          echo "Published release: $VERSION_TAG"
